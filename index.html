<!doctype html>
<html>
<head>
	<meta charset="utf-8"/>
	<title>3D Beispiel</title>
	<script>
	    var zeichenFlaeche; // Unser DIV Element in dem das 3D Bild angezeigt wird
	    var SpinBtnXPos;
	    var SpinBtnYPos;
	    var SpinBtnZPos;
	    var CurSpinBtn;
	    var SpinBtnMouseX;
	    var SpinBtnMouseY
	    var renderer;
		var camera;
		var ambiLight;
		var pointLight;
		var scene;
		var mesh;
		var projector;
		var mouseStat;
		var mousePosX;
		var mousePosY;
		var targetList = [];

		function DocumentLoaded() {
		    $("#accordion").accordion({ heightStyle: "content" });
		    $("#KamaraXpos").slider({ min: 0, max: 2000, value: 1000, slide: function (event, ui) { camera.position.x = ui.value - 1000; $("#XPosKamara").val(camera.position.x); } });
		    $("#KamaraYpos").slider({ min: 0, max: 2000, value: 1000, slide: function (event, ui) { camera.position.y = 1000 - ui.value; $("#YPosKamara").val(camera.position.y); } });
		    $("#KamaraZpos").slider({ min: -1000, max: 1000, value: 500, slide: function (event, ui) { camera.position.z = ui.value; $("#ZPosKamara").val(camera.position.z); } });
		    $("#KamaraXrot").slider({ min: 0, max: 360, value: 180, slide: function (event, ui) { camera.rotation.x = THREE.Math.degToRad(ui.value - 180); $("#XRotKamara").val(ui.value - 180); } });
		    $("#KamaraYrot").slider({ min: 0, max: 360, value: 180, slide: function (event, ui) { camera.rotation.y = THREE.Math.degToRad(ui.value - 180); $("#YRotKamara").val(ui.value - 180); } });
		    $("#KamaraZrot").slider({ min: 0, max: 360, value: 180, slide: function (event, ui) { camera.rotation.z = THREE.Math.degToRad(ui.value - 180); $("#ZRotKamara").val(ui.value - 180); } });
		    $("#AmbiLight").slider({ min: 0, max: 0x00ffffff, value: 0x808080, slide: function (event, ui) { ambiLight.color.setHex(ui.value); console.log(ui.value); } });
		    $("#red, #green, #blue").slider({ min: 0, max: 255, value: 127, slide: function (event, ui) { ambiLight.color.setHex(($("#red").slider("value") << 16) | ($("#green").slider("value") << 8) | $("#blue").slider("value")); $("#swatch").css("background-color", "#" + ambiLight.color.getHexString()); console.log("AmbiLight color: " + ambiLight.color.getHexString()); } });
		    $("#PtLight").slider({ min: 1, max: 30, value: 10, slide: function (event, ui) { pointLight.intensity = ui.value / 10; console.log("PointLight intensity: " + (ui.value / 10)); } });
		    $("#PointLightXpos").slider({ min: -10000, max: 10000, value: 0, slide: function (event, ui) { pointLight.position.x = ui.value; $("#XPosPointLight").val(pointLight.position.x); } });
		    $("#PointLightYpos").slider({ min: -10000, max: 10000, value: 0, slide: function (event, ui) { pointLight.position.y = ui.value; $("#YPosPointLight").val(pointLight.position.y); } });
		    $("#PointLightZpos").slider({ min: -10000, max: 10000, value: 500, slide: function (event, ui) { pointLight.position.z = ui.value; $("#ZPosPointLight").val(pointLight.position.z); } });

		    SpinBtnZPos = document.getElementById("SpinBtnZPos");
		    SpinBtnZPos.addEventListener("mousedown", onSpinBtnDown, false);
		    DrawVertSpinButton(SpinBtnZPos, 11);
		    SpinBtnYPos = document.getElementById("SpinBtnYPos");
		    SpinBtnYPos.addEventListener("mousedown", onSpinBtnDown, false);
		    DrawVertSpinButton(SpinBtnYPos, 11);
		    SpinBtnXPos = document.getElementById("SpinBtnXPos");
		    SpinBtnXPos.addEventListener("mousedown", onSpinBtnDown, false);
		    DrawHorzSpinButton(SpinBtnXPos, 11);

		    zeichenFlaeche = document.getElementById("zeichenflaeche");

		    renderer = new THREE.WebGLRenderer({ antialias: true });
		    // start the renderer
		    renderer.setSize(zeichenFlaeche.clientWidth, zeichenFlaeche.clientHeight);
		    // attach the render-supplied DOM element
		    zeichenFlaeche.appendChild(renderer.domElement);

		    zeichenFlaeche.addEventListener('mousedown', on3DMouseDown, false);
		    zeichenFlaeche.addEventListener('mousewheel', on3DMouseWheel, false);

		    scene = new THREE.Scene();

		    camera = new THREE.PerspectiveCamera(45, zeichenFlaeche.clientWidth / zeichenFlaeche.clientHeight, 1, 10000);
		    // the camera starts at 0,0,0 so pull it back
		    camera.position.z = 500;
		    //camera.position.y = 100;
		    //camera.rotation.x = -0.16;
		    camera.lookAt(scene.position);
		    // and the camera
		    scene.add(camera);

		    // create a point light
		    pointLight = new THREE.PointLight( 0x808080, 1.0, -500 );
	        //var pointLight = new THREE.DirectionalLight( 0xFFFFFF );

		    // set its position
    //		pointLight.position.x = 200;
    //		pointLight.position.y = 150;
		    pointLight.position.z = 500;

		    // add to the scene
		    scene.add(pointLight);

		    ambiLight = new THREE.AmbientLight(0x808080);
		    // add to the scene
		    scene.add(ambiLight);

		    //var geometry = new THREE.CubeGeometry(300, 100, 100);
		    //var material = new THREE.MeshLambertMaterial({ color: 0x00ff00, wireframe: true, transparent: true });
		    //var cube = new THREE.Mesh(geometry, material);		
		    //scene.add(cube);

		    var profquer = new THREE.Shape();

		    profquer.moveTo(0, 0);
		    profquer.lineTo(80, 0);
		    profquer.lineTo(80, 80);
		    profquer.lineTo(0, 80);
		    profquer.lineTo(0, 0);

		    var profkern = new THREE.Path();

		    profkern.moveTo(3, 3);
		    profkern.lineTo(77, 3);
		    profkern.lineTo(77, 77);
		    profkern.lineTo(3, 77);
		    profkern.lineTo(3, 3);

		    profquer.holes.push(profkern);
            /*
		    var extrusionSettings = {
		        amount: 400,
		        bevelEnabled: true,
		        bevelThickness: 0.5,
		        bevelSize: 0.5,
		        bevelSegments: 8,
		        material: 0,
		        extrudeMaterial: 1
		    };
            */
		    var extrusionSettings = { amount: 800, bevelEnabled: false };

		    var profile = new THREE.ExtrudeGeometry(profquer, extrusionSettings);

		    var materialFront = new THREE.MeshLambertMaterial({ color: 0xffffff, shading: THREE.SmoothShading });
		    var materialSide = new THREE.MeshLambertMaterial({ color: 0xc2c2c2, shading: THREE.SmoothShading });
		    //var material = new THREE.MeshFaceMaterial([materialFront, materialSide]);
		    //var material = new THREE.MeshLambertMaterial({ shading: THREE.SmoothShading, map: THREE.ImageUtils.loadTexture('C:\\Users\\THA\\webGl\\texture.png') })
		    //var material = new THREE.MeshLambertMaterial({ color: 0xc2c2c2 });
		    //var material = new THREE.MeshBasicMaterial({ wireframe: false, color: 'blue' });
		    //var material = new THREE.MeshNormalMaterial();
		    /*var material = new THREE.MeshPhongMaterial({
		        // light
		        specular: '#a9fcff',
		        // intermediate
		        color: '#00abb1',
		        // dark
		        emissive: '#006063',
		        shininess: 100
		    });*/
		    var material = new THREE.MeshLambertMaterial({
		        map: THREE.ImageUtils.loadTexture('texture.png')
		    });

		    mesh = new THREE.Mesh(profile);
		    mesh.position.set(0, 0, -500);


    var profCsg = new ThreeBSP(mesh);

	var Hole = new THREE.CylinderGeometry(10, 10, 10, 20, 1, false);
	var HoleMesh = new THREE.Mesh(Hole);

	HoleMesh.position.set(40, 78, -400);
	var holeCsg = new ThreeBSP(HoleMesh);
	var profCsg = profCsg.subtract(holeCsg);

	HoleMesh.position.set(40, 78, -300);
	holeCsg = new ThreeBSP(HoleMesh);
	var profCsg = profCsg.subtract(holeCsg);

	HoleMesh.position.set(40, 78, -500);
	holeCsg = new ThreeBSP(HoleMesh);
	var profCsg = profCsg.subtract(holeCsg);

	HoleMesh.position.set(40, 78, 200);
	holeCsg = new ThreeBSP(HoleMesh);
	var profCsg = profCsg.subtract(holeCsg);

	mesh = profCsg.toMesh(material);
	mesh.geometry.computeVertexNormals();
	//scene.add(mesh);

/*
	var cube_geometry = new THREE.CubeGeometry(3, 3, 3);
	var cube_mesh = new THREE.Mesh(cube_geometry);
	cube_mesh.position.x = -7;
	var cube_bsp = new ThreeBSP(cube_mesh);


	var sphere_geometry = new THREE.SphereGeometry(1.8, 32, 32);
	var sphere_mesh = new THREE.Mesh(sphere_geometry);
	sphere_mesh.position.x = -7;
	var sphere_bsp = new ThreeBSP(sphere_mesh);


	var subtract_bsp = cube_bsp.subtract(sphere_bsp);
	var result = subtract_bsp.toMesh(new THREE.MeshLambertMaterial({ shading: THREE.SmoothShading, map: THREE.ImageUtils.loadTexture('texture.png') }));
	result.geometry.computeVertexNormals();
	scene.add(result);
*/

		    //mesh.rotation.y = THREE.Math.degToRad(150);
		    //mesh.rotation.z = THREE.Math.degToRad(20);
	        //mesh.position.set(-150, -050, 0);
            scene.add(mesh);
		    targetList.push(mesh);

//		    scene.add(HoleMesh);
//		    targetList.push(HoleMesh);

		    // initialize object to perform world/screen calculations
		    projector = new THREE.Projector();

			// draw!
			render();

			document.getElementById("btnFront").onclick = btnFrontclick;
			document.getElementById("btnLinks").onclick = btnLinksclick;
        };
		
		var render = function () {
				requestAnimationFrame(render);
				renderer.render(scene, camera);
		}
			
		// Hier fangen wir einige Events ab, wie Taste gedrückt, rechts click und selecting the text
		document.addEventListener('DOMContentLoaded', DocumentLoaded, false);
		document.oncontextmenu = function() { return false; }
		document.onselectstart = function() { return false; }
		
		function on3DMouseDown( event ) {
			event.preventDefault();
			zeichenFlaeche.addEventListener('mousemove', on3DMouseMove, false);
			zeichenFlaeche.addEventListener('mouseup', on3DMouseUp, false);
			zeichenFlaeche.addEventListener('mouseout', on3DMouseOut, false);

			mouseStat = "down";
			mousePosX = event.clientX;
			mousePosY = event.clientY;

		    // find intersections
			var x = (event.clientX - $('#zeichenflaeche').offset().left) + $(window).scrollLeft();
			var y = (event.clientY - $('#zeichenflaeche').offset().top) + $(window).scrollTop();
		    // update the mouse variable
			var mouse = { x: 0, y: 0 };
			mouse.x = (x / $('#zeichenflaeche').width()) * 2 - 1;
			mouse.y = -(y / $('#zeichenflaeche').height()) * 2 + 1;


		    // create a Ray with origin at the mouse position
		    //   and direction into the scene (camera direction)
			var vector = new THREE.Vector3(mouse.x, mouse.y, 1);
			projector.unprojectVector(vector, camera);
			vector.sub(camera.position);
			vector.normalize();
			var ray = new THREE.Raycaster(camera.position, vector);

		    // create an array containing all objects in the scene with which the ray intersects
			var intersects = ray.intersectObjects(targetList);

		    // if there is one (or more) intersections
			if (intersects.length > 0) {
			    var pt = intersects[0].point;
			    pt.x -= mesh.position.x;
			    pt.y -= mesh.position.y;
			    pt.z -= mesh.position.z;
			    console.log("Hit X: " + pt.x + " Y: " + pt.y + " Z: " + pt.z);

                // Drehpunkt setzen
			    //mesh.applyMatrix(new THREE.Matrix4().makeTranslation(0, 10, 0));
			}
        }

		function on3DMouseMove( event ) {
		    if (mouseStat == "down") {
		        var deltaX = event.clientX - mousePosX;
		        var deltaY = event.clientY - mousePosY;
		        mesh.rotation.x += THREE.Math.degToRad(deltaY);
		        mesh.rotation.y += THREE.Math.degToRad(deltaX);
		        mousePosX = event.clientX;
		        mousePosY = event.clientY;
            }
		}

		function on3DMouseUp( event ) {
		    zeichenFlaeche.removeEventListener('mousemove', on3DMouseMove, false);
		    zeichenFlaeche.removeEventListener('mouseup', on3DMouseUp, false);
		    zeichenFlaeche.removeEventListener('mouseout', on3DMouseOut, false);

		    mouseStat = "up";
		}

		function on3DMouseOut( event ) {
		    zeichenFlaeche.removeEventListener('mousemove', on3DMouseMove, false);
		    zeichenFlaeche.removeEventListener('mouseup', on3DMouseUp, false);
		    zeichenFlaeche.removeEventListener('mouseout', on3DMouseOut, false);

		    mouseStat = "up";
		}
		
		function on3DMouseWheel( event ) {
			event.preventDefault();
			camera.position.z += (event.wheelDelta / 120) * 5;
		}

		function btnFrontclick() {
		    mesh.rotation.x = 0;
		    mesh.rotation.y = THREE.Math.degToRad(90);
		    mesh.rotation.z = 0;
        }
		function btnLinksclick() {
		    mesh.rotation.x = 0;
		    mesh.rotation.y = THREE.Math.degToRad(180);
		    mesh.rotation.z = 0;
		}

		function DrawVertSpinButton(elm, offset) {
		    if (elm.getContext) {
		        var context = elm.getContext('2d');
		        context.clearRect(0, 0, elm.clientWidth, elm.clientHeight);
		        context.beginPath();
		        context.moveTo(elm.clientWidth, 8);
		        context.lineTo(elm.clientWidth, elm.clientHeight - 8);
		        context.quadraticCurveTo(elm.clientWidth / 2, elm.clientHeight + 8, 0, elm.clientHeight - 8);
		        context.lineTo(0, 8);
		        context.quadraticCurveTo(elm.clientWidth / 2, -8, elm.clientWidth, 8);

		        context.moveTo(4, 3);
		        context.lineTo(4, elm.clientHeight - 3);
		        context.moveTo(8, 3);
		        context.lineTo(8, elm.clientHeight - 3);

		        if (offset < 0)
		            offset *= -1;
		        offset /= 2;
		        if (offset > 8)
		            offset %= 8;

		        for (var i = offset; i < elm.clientHeight - 16; i += 8) {
		            if (i > 0 && i < elm.clientHeight - 8) {
		                context.moveTo(0, 8 + i);
		                var noff = ((i * 32) / 42) - 8 + i;
		                context.quadraticCurveTo(elm.clientWidth / 2, noff, elm.clientWidth, 8 + i);
		            }
		        }

		        context.stroke();
		    }
		}
		function DrawHorzSpinButton(elm, offset) {
		    if (elm.getContext) {
		        var context = elm.getContext('2d');
		        context.clearRect(0, 0, elm.clientWidth, elm.clientHeight);
		        context.beginPath();
		        context.moveTo(8, 0);
		        context.lineTo(elm.clientWidth - 8, 0);
		        context.quadraticCurveTo(elm.clientWidth + 8, elm.clientHeight / 2, elm.clientWidth - 8, elm.clientHeight);
		        context.lineTo(8, elm.clientHeight);
		        context.quadraticCurveTo(-8, elm.clientHeight / 2, 8, 0);

		        context.moveTo(3, 4);
		        context.lineTo(elm.clientWidth - 3, 4);
		        context.moveTo(3, 8);
		        context.lineTo(elm.clientWidth - 3, 8);

		        if (offset < 0)
		            offset *= -1;
		        offset /= 2;
		        if (offset > 8)
		            offset %= 8;

		        for (var i = offset; i < elm.clientWidth - 16; i += 8) {
		            if (i > 0 && i < elm.clientWidth - 8) {
		                context.moveTo(8 + i, 0);
		                var noff = ((i * 32) / 42) - 8 + i;
		                context.quadraticCurveTo(noff, elm.clientHeight / 2, 8 + i, elm.clientHeight);
		            }
		        }

		        context.stroke();
		    }
		}
		function onSpinBtnDown(event) {
		    event.preventDefault();
		    document.addEventListener('mousemove', onSpinBtnMove, false);
		    document.addEventListener('mouseup', onSpinBtnUp, false);
		    CurSpinBtn = this;
		    SpinBtnMouseX = event.clientX;
		    SpinBtnMouseY = event.clientY;
		}
		function onSpinBtnMove(event) {
		    event.preventDefault();
		    if (CurSpinBtn === SpinBtnYPos) {
		        DrawVertSpinButton(SpinBtnYPos, event.clientY);
		        mesh.position.y -= (event.clientY - SpinBtnMouseY) * 3;
		        SpinBtnMouseY = event.clientY;
		    }
		    else if (CurSpinBtn === SpinBtnXPos) {
		        DrawHorzSpinButton(CurSpinBtn, event.clientX);
		        mesh.position.x += (event.clientX - SpinBtnMouseX) * 3;
		        SpinBtnMouseX = event.clientX;
		    }
		    else if (CurSpinBtn === SpinBtnZPos) {
		        DrawVertSpinButton(CurSpinBtn, event.clientY);
		        mesh.position.z += (event.clientY - SpinBtnMouseY) * 3;
		        SpinBtnMouseY = event.clientY;
		    }
        }
		function onSpinBtnUp(event) {
		    document.removeEventListener('mousemove', onSpinBtnMove, false);
		    document.removeEventListener('mouseup', onSpinBtnUp, false);
		}
	</script>

	<style type="text/css">
		body { margin:0px; cursor:default; padding:0px; border:0px; }
	    #container { width: 600px; margin-left:auto; margin-right:auto; padding-top:50px; }
        #ctrlTopLeiste { width: 530px; height: 30px; background:rgb(241, 240, 240); margin:inherit; border-top:solid 1px black; border-left:solid 1px black; border-right:solid 1px black; overflow: hidden; }
	    #ctrlund3D { width: 532px; margin:inherit; overflow: hidden; }
        #ctrlRSideLeiste { width: 29px; height: 400px; background:rgb(241, 240, 240); border-left:solid 1px black; border-top:solid 1px black; border-bottom:solid 1px black; float:left; }
		#zeichenflaeche { width: 500px; height: 400px; background-image: linear-gradient(white 0%, #9FBFD2 100%); margin-left: 30px; border:solid 1px black; overflow: hidden; }
	    .ctrlBtn { height:24px; width:50px; text-align:center; margin-left:3px; margin-top:3px; }
	    #accordion { width: 600px; margin-top:30px; font-size: .7em; }
	    .SpinBtnVert { width:12px; height:60px; cursor:pointer; }
	    #SpinBtnYPos { margin-top:30px; margin-left:10px; }
        #SpinBtnZPos { margin-top:220px; margin-left:10px; }
	    .SpinBtnHorz { width:60px; height:12px; cursor:pointer; }
	    #SpinBtnXPos { margin-left:310px; margin-top:10px; }

        #red, #green, #blue { float: left; clear: left; width: 370px;  margin: 15px; }
        #swatch { width: 120px; height: 100px; margin-top: 18px;  margin-left: 420px; background-image: none; }
        #red .ui-slider-range { background: #ef2929; }
        #red .ui-slider-handle { border-color: #ef2929; }
        #green .ui-slider-range { background: #8ae234; }
        #green .ui-slider-handle { border-color: #8ae234; }
        #blue .ui-slider-range { background: #729fcf; }
        #blue .ui-slider-handle { border-color: #729fcf; }
	</style>
	
	</head>
	
	<body>
        <div id="container">
            <div id="ctrlTopLeiste">
                <button id="btnFront" class="ctrlBtn">Vorne</button>
                <button id="btnLinks" class="ctrlBtn">Links</button>
                <canvas id="SpinBtnXPos" class="SpinBtnHorz" width="60" height="12">...</canvas>
            </div>
            <div id="ctrlund3D">
                <div id="ctrlRSideLeiste">
                    <canvas id="SpinBtnZPos" class="SpinBtnVert" width="12" height="60">...</canvas>
                    <canvas id="SpinBtnYPos" class="SpinBtnVert" width="12" height="60">...</canvas>
                </div>
		        <div id="zeichenflaeche"></div>
            </div>
            <div id="accordion">
                <h3>Kamara</h3>
                <div>
                    <label for="KamaraXpos">X Position der Kamara:</label><input type="text" id="XPosKamara" style="border: 0; color: #f6931f;" />
                    <div id="KamaraXpos"></div>
                    <label for="KamaraYpos">Y Position der Kamara:</label><input type="text" id="YPosKamara" style="border: 0; color: #f6931f;" />
                    <div id="KamaraYpos"></div>
                    <label for="KamaraZpos">Z Position der Kamara:</label><input type="text" id="ZPosKamara" style="border: 0; color: #f6931f;" />
                    <div id="KamaraZpos"></div>
                    <label for="XRotKamara">Kamara-Winckel um X:</label><input type="text" id="XRotKamara" style="border: 0; color: #f6931f;" />
                    <div id="KamaraXrot"></div>
                    <label for="YRotKamara">Kamara-Winckel um Y:</label><input type="text" id="YRotKamara" style="border: 0; color: #f6931f;" />
                    <div id="KamaraYrot"></div>
                    <label for="ZRotKamara">Kamara-Winckel um Z:</label><input type="text" id="ZRotKamara" style="border: 0; color: #f6931f;" />
                    <div id="KamaraZrot"></div>
                </div>
                <h3>3D Object</h3>
                <div>
                </div>
                <h3>Umgebungslicht</h3>
                <div>
                    <label for="AmbiLeihgt">Helligkeit:</label><input type="text" id="Text1" style="border: 0; color: #f6931f;" />
                    <div id="AmbiLight"></div>

                    <div id="red"></div>
                    <div id="green"></div>
                    <div id="blue"></div>
                    <div id="swatch" class="ui-widget-content ui-corner-all"></div>
                </div>
                <h3>Strahllicht</h3>
                <div>
                    <label for="PointLight">Helligkeit:</label><input type="text" id="Text2" style="border: 0; color: #f6931f;" />
                    <div id="PtLight"></div>
                    <label for="PointLightXpos">X Position des Lichtstrahlers:</label><input type="text" id="XPosPointLight" style="border: 0; color: #f6931f;" />
                    <div id="PointLightXpos"></div>
                    <label for="PointLightYpos">Y Position der Lichtstrahlers:</label><input type="text" id="YPosPointLight" style="border: 0; color: #f6931f;" />
                    <div id="PointLightYpos"></div>
                    <label for="PointLightZpos">Z Position der Lichtstrahlers:</label><input type="text" id="ZPosPointLight" style="border: 0; color: #f6931f;" />
                    <div id="PointLightZpos"></div>
                </div>
            </div>
        </div>

    </body>
</html>
